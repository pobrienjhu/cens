from os import listdir
from os.path import isfile, join
import os
import logging
import csv
import sys
from collections import defaultdict
import numpy
import networkx
import matplotlib.pyplot as plt
import timeit
import SimulationUtils
import Simulation
import time
import FileGraphGenerator



logger = logging.getLogger('Run Simulation for graph files')

# Set the log levels
logger.setLevel(logging.DEBUG)

mypath = "Doctoral.Research/Exploration.vs.Exploitation - Structural Design/results/graphFiles"

# The number of dimensions of reality
# 30 is the number from the original March experiment
m = [100] #[40,70,100,130,160]

# degree of complexity
s = [3] #1,3,5,7,10]

# effectiveness of learning
# The p values represent the probability of change
# p1 effectiveness of learning (socialization) 
pl = [0.3] #0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9]

#probability of turnover
pt = [0] #[0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1.0]

#probability of change in each element of reality
pe = [0] #[0.1,0.4,0.7]

#interval of environmental change
T = 0
# number of different graphs to generate
graphsToRun = 1

# number of times to run the simulations
iterations = 50
recordEachRun = False 

filesProcessedCount = 0

plt.ion()

ct = 1

for root, dirs, files in os.walk(mypath):
    for fileSt in files:
        if(fileSt.endswith("graphml") ):
            logger.debug( "    "+str(fileSt) )
            graph = networkx.read_graphml( mypath+"/"+fileSt )
            #plt.figure(ct)
            #plt.title(fileSt)
            #pos = networkx.spring_layout(graph)
            #networkx.draw(graph, pos, with_label=False)
            ct += 1
            
            # Run the simulation for the loaded graph file
            for graphCount in range(0,graphsToRun): 
                timeStamp = time.time()    
                graphName = fileSt.split(".")[0]
                useDir = mypath+"/"+graphName+"/run-"+str(timeStamp) 
                SimulationUtils.validateDir(useDir)
                logger.debug("using Dir |"+useDir+"|")
                # number of individuals  in the organization
                # 50 is the number from the original March experiment
                n = [len(graph.nodes())]  
                graphGenerator = FileGraphGenerator.FileGraphGenerator(graph,graphName,timeStamp) 
                Simulation.simulation(m,n,s,pl,pt,pe,T,iterations,graphGenerator,useDir,recordEachRun)



#plt.show()